<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 550" font-family="system-ui, -apple-system, sans-serif">
  <defs>
    <linearGradient id="eventGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="behaviourGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#a78bfa;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="streamGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="backendGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4ade80;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#22c55e;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.2"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b" />
    </marker>
    <marker id="arrowheadOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b" />
    </marker>
    <marker id="arrowheadBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6" />
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="550" fill="#f8fafc"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" font-size="24" font-weight="bold" fill="#1e293b">Lineage Event Architecture</text>
  <text x="450" y="55" text-anchor="middle" font-size="14" fill="#64748b">Persistent Genealogy Tracking for Neuroevolution</text>

  <!-- Event Sources (left side) -->
  <g transform="translate(30, 85)">
    <text x="85" y="0" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e293b">Event Sources</text>

    <!-- Evolution Server -->
    <rect x="10" y="15" width="150" height="50" rx="8" fill="url(#eventGrad)" filter="url(#shadow)"/>
    <text x="85" y="38" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Evolution Server</text>
    <text x="85" y="52" text-anchor="middle" font-size="10" fill="white" opacity="0.9">birth, death, selection</text>

    <!-- Evaluator -->
    <rect x="10" y="75" width="150" height="50" rx="8" fill="url(#eventGrad)" filter="url(#shadow)"/>
    <text x="85" y="98" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Evaluator</text>
    <text x="85" y="112" text-anchor="middle" font-size="10" fill="white" opacity="0.9">fitness events</text>

    <!-- Mutation Engine -->
    <rect x="10" y="135" width="150" height="50" rx="8" fill="url(#eventGrad)" filter="url(#shadow)"/>
    <text x="85" y="158" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Mutation Engine</text>
    <text x="85" y="172" text-anchor="middle" font-size="10" fill="white" opacity="0.9">topology changes</text>

    <!-- Speciation -->
    <rect x="10" y="195" width="150" height="50" rx="8" fill="url(#eventGrad)" filter="url(#shadow)"/>
    <text x="85" y="218" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Speciation</text>
    <text x="85" y="232" text-anchor="middle" font-size="10" fill="white" opacity="0.9">lineage divergence</text>

    <!-- Knowledge Transfer -->
    <rect x="10" y="255" width="150" height="50" rx="8" fill="url(#eventGrad)" filter="url(#shadow)"/>
    <text x="85" y="278" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Knowledge Transfer</text>
    <text x="85" y="292" text-anchor="middle" font-size="10" fill="white" opacity="0.9">mentorship, cloning</text>
  </g>

  <!-- Arrows from sources to behaviour -->
  <line x1="190" y1="125" x2="290" y2="200" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowheadOrange)"/>
  <line x1="190" y1="185" x2="290" y2="210" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowheadOrange)"/>
  <line x1="190" y1="245" x2="290" y2="220" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowheadOrange)"/>
  <line x1="190" y1="305" x2="290" y2="230" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowheadOrange)"/>
  <line x1="190" y1="365" x2="290" y2="240" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowheadOrange)"/>

  <!-- Behaviour Interface (center) -->
  <g transform="translate(290, 120)">
    <rect x="0" y="0" width="200" height="200" rx="12" fill="white" stroke="#8b5cf6" stroke-width="3" filter="url(#shadow)"/>
    <rect x="0" y="0" width="200" height="45" rx="12" fill="url(#behaviourGrad)"/>
    <rect x="0" y="33" width="200" height="12" fill="url(#behaviourGrad)"/>
    <text x="100" y="30" text-anchor="middle" font-size="13" font-weight="bold" fill="white">neuroevolution_lineage_events</text>

    <!-- Callbacks -->
    <text x="100" y="65" text-anchor="middle" font-size="11" font-weight="600" fill="#5b21b6">Required Callbacks</text>
    <text x="20" y="82" font-size="9" fill="#64748b">init/1, persist_event/2</text>
    <text x="20" y="95" font-size="9" fill="#64748b">persist_batch/2, get_lineage/2</text>
    <text x="20" y="108" font-size="9" fill="#64748b">get_species_history/2</text>
    <text x="20" y="121" font-size="9" fill="#64748b">get_population_timeline/3</text>
    <text x="20" y="134" font-size="9" fill="#64748b">replay_from/3</text>

    <text x="100" y="155" text-anchor="middle" font-size="11" font-weight="600" fill="#5b21b6">Optional Callbacks</text>
    <text x="20" y="172" font-size="9" fill="#64748b">get_breeding_tree/2</text>
    <text x="20" y="185" font-size="9" fill="#64748b">get_mutation_history/2</text>
  </g>

  <!-- Arrow to backend -->
  <text x="390" y="345" text-anchor="middle" font-size="11" fill="#64748b">implements</text>
  <line x1="390" y1="320" x2="390" y2="370" stroke="#64748b" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>

  <!-- Backend Implementation -->
  <g transform="translate(290, 380)">
    <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#backendGrad)" filter="url(#shadow)"/>
    <text x="100" y="25" text-anchor="middle" font-size="12" font-weight="bold" fill="white">neuroevolution_lineage_esdb</text>
    <text x="100" y="42" text-anchor="middle" font-size="10" fill="white" opacity="0.9">faber-neuroevolution-evoq</text>
    <text x="100" y="58" text-anchor="middle" font-size="9" fill="white" opacity="0.8">via evoq_event_store</text>
  </g>

  <!-- Arrow to streams -->
  <line x1="490" y1="220" x2="560" y2="220" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="525" y="210" text-anchor="middle" font-size="10" fill="#64748b">route by</text>
  <text x="525" y="222" text-anchor="middle" font-size="10" fill="#64748b">entity type</text>

  <!-- Event Streams (right side) -->
  <g transform="translate(560, 85)">
    <text x="150" y="0" text-anchor="middle" font-size="14" font-weight="bold" fill="#1e293b">Event Streams</text>

    <!-- Individual Stream -->
    <rect x="10" y="15" width="280" height="70" rx="8" fill="url(#streamGrad)" filter="url(#shadow)"/>
    <text x="150" y="38" text-anchor="middle" font-size="12" font-weight="bold" fill="white">individual-{id}</text>
    <text x="150" y="55" text-anchor="middle" font-size="10" fill="white" opacity="0.9">birth, death, fitness, mutations</text>
    <text x="150" y="70" text-anchor="middle" font-size="10" fill="white" opacity="0.9">knowledge transfer, epigenetics</text>

    <!-- Species Stream -->
    <rect x="10" y="95" width="280" height="55" rx="8" fill="url(#streamGrad)" filter="url(#shadow)"/>
    <text x="150" y="118" text-anchor="middle" font-size="12" font-weight="bold" fill="white">species-{id}</text>
    <text x="150" y="135" text-anchor="middle" font-size="10" fill="white" opacity="0.9">speciation, lineage divergence/merge</text>

    <!-- Population Stream -->
    <rect x="10" y="160" width="280" height="55" rx="8" fill="url(#streamGrad)" filter="url(#shadow)"/>
    <text x="150" y="183" text-anchor="middle" font-size="12" font-weight="bold" fill="white">population-{id}</text>
    <text x="150" y="200" text-anchor="middle" font-size="10" fill="white" opacity="0.9">generation, capacity, catastrophe</text>

    <!-- Coalition Stream -->
    <rect x="10" y="225" width="280" height="55" rx="8" fill="url(#streamGrad)" filter="url(#shadow)"/>
    <text x="150" y="248" text-anchor="middle" font-size="12" font-weight="bold" fill="white">coalition-{id}</text>
    <text x="150" y="265" text-anchor="middle" font-size="10" fill="white" opacity="0.9">formation, dissolution, membership</text>
  </g>

  <!-- Query Flow (bottom) -->
  <g transform="translate(560, 395)">
    <rect x="10" y="0" width="280" height="80" rx="8" fill="white" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="22" text-anchor="middle" font-size="12" font-weight="bold" fill="#1e293b">Query Patterns</text>
    <text x="30" y="42" font-size="10" fill="#64748b">get_lineage(IndividualId)</text>
    <text x="30" y="56" font-size="10" fill="#64748b">get_breeding_tree(IndividualId)</text>
    <text x="30" y="70" font-size="10" fill="#64748b">get_fitness_trajectory(IndividualId)</text>
  </g>

  <!-- Arrow from backend to streams -->
  <line x1="490" y1="415" x2="560" y2="400" stroke="#22c55e" stroke-width="2" stroke-dasharray="5,3"/>

  <!-- Legend -->
  <g transform="translate(30, 480)">
    <rect x="0" y="0" width="280" height="55" rx="6" fill="white" stroke="#e2e8f0" stroke-width="1"/>
    <text x="140" y="18" text-anchor="middle" font-size="11" font-weight="600" fill="#1e293b">Legend</text>
    <rect x="15" y="28" width="16" height="12" rx="2" fill="#f59e0b"/>
    <text x="38" y="38" font-size="10" fill="#64748b">Event Sources</text>
    <rect x="100" y="28" width="16" height="12" rx="2" fill="#8b5cf6"/>
    <text x="123" y="38" font-size="10" fill="#64748b">Behaviour</text>
    <rect x="180" y="28" width="16" height="12" rx="2" fill="#3b82f6"/>
    <text x="203" y="38" font-size="10" fill="#64748b">Streams</text>
  </g>

  <!-- Event count badge -->
  <g transform="translate(750, 480)">
    <rect x="0" y="0" width="120" height="55" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
    <text x="60" y="20" text-anchor="middle" font-size="11" font-weight="600" fill="#92400e">Event Types</text>
    <text x="60" y="38" text-anchor="middle" font-size="20" font-weight="bold" fill="#f59e0b">45+</text>
    <text x="60" y="50" text-anchor="middle" font-size="9" fill="#92400e">lineage_events.hrl</text>
  </g>
</svg>
