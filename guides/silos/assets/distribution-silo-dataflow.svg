<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 500">
  <defs>
    <linearGradient id="distGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#fb923c"/>
      <stop offset="100%" style="stop-color:#f59e0b"/>
    </linearGradient>
    <linearGradient id="meshGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#06b6d4"/>
      <stop offset="100%" style="stop-color:#0891b2"/>
    </linearGradient>
    <linearGradient id="taskGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#5BA3E0"/>
      <stop offset="100%" style="stop-color:#4A90D9"/>
    </linearGradient>
    <marker id="arrowOrange2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
    </marker>
    <marker id="arrowCyan2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#0891b2"/>
    </marker>
    <marker id="arrowPurple3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7B68EE"/>
    </marker>
    <marker id="arrowBlue3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4A90D9"/>
    </marker>
    <filter id="shadowDist2" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.2"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="500" fill="#f8fafc"/>

  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#1e293b">Distribution Silo Integration &amp; Dataflow</text>

  <!-- Mesh Network Box -->
  <rect x="40" y="60" width="180" height="160" rx="10" fill="white" stroke="#0891b2" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="40" y="60" width="180" height="30" rx="10" fill="url(#meshGrad)"/>
  <rect x="40" y="80" width="180" height="10" fill="url(#meshGrad)"/>
  <text x="130" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Mesh Network</text>

  <text x="55" y="110" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Peer discovery</text>
  <text x="55" y="125" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Load heartbeats</text>
  <text x="55" y="140" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Latency measurements</text>
  <text x="55" y="155" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Bandwidth detection</text>
  <text x="55" y="170" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Remote evaluations</text>
  <text x="55" y="185" font-family="Arial, sans-serif" font-size="10" fill="#0e7490">Migration transport</text>

  <!-- Distribution Silo Box -->
  <rect x="300" y="55" width="300" height="180" rx="10" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="300" y="55" width="300" height="35" rx="10" fill="url(#distGrad2)"/>
  <rect x="300" y="80" width="300" height="10" fill="url(#distGrad2)"/>
  <text x="450" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">Distribution Silo</text>

  <text x="315" y="110" font-family="Arial, sans-serif" font-size="10" fill="#b45309">get_distribution_params()</text>
  <text x="315" y="128" font-family="Arial, sans-serif" font-size="10" fill="#b45309">update_peer_metrics()</text>
  <text x="315" y="146" font-family="Arial, sans-serif" font-size="10" fill="#b45309">update_island_topology()</text>
  <text x="315" y="164" font-family="Arial, sans-serif" font-size="10" fill="#b45309">update_migration_result()</text>

  <!-- L0 Components -->
  <rect x="480" y="105" width="105" height="25" rx="4" fill="#fbbf24" opacity="0.3" stroke="#f59e0b"/>
  <text x="532" y="122" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#92400e">routing decisions</text>
  <rect x="480" y="135" width="105" height="25" rx="4" fill="#fbbf24" opacity="0.3" stroke="#f59e0b"/>
  <text x="532" y="152" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#92400e">migration control</text>
  <rect x="480" y="165" width="105" height="25" rx="4" fill="#fbbf24" opacity="0.3" stroke="#f59e0b"/>
  <text x="532" y="182" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#92400e">island topology</text>

  <!-- Cross-silo notes -->
  <rect x="315" y="195" width="270" height="30" rx="4" fill="#e0f2fe" stroke="#0ea5e9"/>
  <text x="450" y="214" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#0369a1">Cross-silo: resource_pressure, task_exploration</text>

  <!-- Resource Silo Box -->
  <rect x="660" y="60" width="200" height="100" rx="10" fill="white" stroke="#7B68EE" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="660" y="60" width="200" height="30" rx="10" fill="#7B68EE"/>
  <rect x="660" y="80" width="200" height="10" fill="#7B68EE"/>
  <text x="760" y="82" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Resource Silo</text>

  <text x="675" y="110" font-family="Arial, sans-serif" font-size="10" fill="#5b21b6">Sends:</text>
  <text x="675" y="125" font-family="monospace" font-size="9" fill="#5b21b6">pressure_signal</text>
  <text x="675" y="140" font-family="monospace" font-size="9" fill="#5b21b6">local_capacity</text>

  <!-- Task Silo Box -->
  <rect x="660" y="180" width="200" height="100" rx="10" fill="white" stroke="#4A90D9" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="660" y="180" width="200" height="30" rx="10" fill="url(#taskGrad2)"/>
  <rect x="660" y="200" width="200" height="10" fill="url(#taskGrad2)"/>
  <text x="760" y="202" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Task Silo</text>

  <text x="675" y="230" font-family="Arial, sans-serif" font-size="10" fill="#1e40af">Sends:</text>
  <text x="675" y="245" font-family="monospace" font-size="9" fill="#1e40af">exploration_boost</text>
  <text x="675" y="260" font-family="monospace" font-size="9" fill="#1e40af">diversity_need</text>

  <!-- Island Population Box -->
  <rect x="300" y="300" width="300" height="90" rx="10" fill="white" stroke="#10b981" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="300" y="300" width="300" height="30" rx="10" fill="#10b981"/>
  <rect x="300" y="320" width="300" height="10" fill="#10b981"/>
  <text x="450" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Island Populations</text>

  <text x="315" y="350" font-family="Arial, sans-serif" font-size="10" fill="#166534">Receives distribution params:</text>
  <text x="315" y="365" font-family="monospace" font-size="9" fill="#166534">migration_rate, target_island_selection</text>
  <text x="315" y="380" font-family="monospace" font-size="9" fill="#166534">island_split_threshold, island_merge_threshold</text>

  <!-- Event Bus Box -->
  <rect x="660" y="300" width="200" height="90" rx="10" fill="white" stroke="#db2777" stroke-width="2" filter="url(#shadowDist2)"/>
  <rect x="660" y="300" width="200" height="30" rx="10" fill="#ec4899"/>
  <rect x="660" y="320" width="200" height="10" fill="#ec4899"/>
  <text x="760" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Event Bus</text>

  <text x="675" y="350" font-family="Arial, sans-serif" font-size="9" fill="#9d174d">migration_completed</text>
  <text x="675" y="365" font-family="Arial, sans-serif" font-size="9" fill="#9d174d">island_split_occurred</text>
  <text x="675" y="380" font-family="Arial, sans-serif" font-size="9" fill="#9d174d">load_rebalanced</text>

  <!-- Arrows -->
  <!-- Mesh to Distribution -->
  <path d="M220 140 L290 140" stroke="#0891b2" stroke-width="2" marker-end="url(#arrowCyan2)"/>
  <text x="255" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#0891b2">metrics</text>

  <!-- Distribution to Mesh -->
  <path d="M290 170 L220 170" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowOrange2)"/>
  <text x="255" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f59e0b">routing</text>

  <!-- Resource to Distribution -->
  <path d="M660 110 L610 130" stroke="#7B68EE" stroke-width="1.5" marker-end="url(#arrowPurple3)"/>
  <text x="640" y="110" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#7B68EE">pressure</text>

  <!-- Task to Distribution -->
  <path d="M660 230 L610 180" stroke="#4A90D9" stroke-width="1.5" marker-end="url(#arrowBlue3)"/>
  <text x="640" y="215" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#4A90D9">exploration</text>

  <!-- Distribution to Islands -->
  <path d="M450 235 L450 290" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowOrange2)"/>
  <text x="480" y="270" text-anchor="start" font-family="Arial, sans-serif" font-size="9" fill="#f59e0b">params</text>

  <!-- Distribution to Events -->
  <path d="M600 200 L660 320" stroke="#db2777" stroke-width="1.5" stroke-dasharray="4,2"/>
  <text x="635" y="265" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#db2777">events</text>

  <!-- Control Flow Box -->
  <rect x="40" y="410" width="820" height="75" rx="8" fill="white" stroke="#cbd5e1" stroke-width="1"/>
  <text x="450" y="432" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1e293b">Routing &amp; Migration Loop (every 1s)</text>

  <text x="60" y="455" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">1.</tspan> Sample peer metrics (load, latency, bandwidth)
  </text>
  <text x="60" y="475" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">2.</tspan> Compute local_vs_remote_ratio for routing
  </text>
  <text x="310" y="455" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">3.</tspan> Check migration cooldown, compute rate
  </text>
  <text x="310" y="475" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">4.</tspan> Select migrants and target islands
  </text>
  <text x="560" y="455" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">5.</tspan> Check island split/merge thresholds
  </text>
  <text x="560" y="475" font-family="Arial, sans-serif" font-size="10" fill="#334155">
    <tspan font-weight="bold">6.</tspan> Apply topology changes, emit events
  </text>
</svg>
